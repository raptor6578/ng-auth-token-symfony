!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/common"),require("@angular/common/http"),require("rxjs"),require("js-base64"),require("@angular/router"),require("rxjs/operators")):"function"==typeof define&&define.amd?define(["exports","@angular/core","@angular/common","@angular/common/http","rxjs","js-base64","@angular/router","rxjs/operators"],t):t((e=e||self)["token-auth"]={},e.vendor._angular_core,e.vendor._angular_common,e.vendor._angular_common_http,e.vendor._rxjs,e.jsBase64,e.vendor._angular_router,e.vendor._rxjs_operators)}(this,function(e,o,r,i,n,a,t,u){"use strict";var c=function(e,t,o,r){var n,i=arguments.length,a=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,o,r);else for(var u=e.length-1;0<=u;u--)(n=e[u])&&(a=(i<3?n(a):3<i?n(t,o,a):n(t,o))||a);return 3<i&&a&&Object.defineProperty(t,o,a),a},f=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},s=function(o,r){return function(e,t){r(e,t,o)}},l=function(){function e(e,t,o){if(this.config=e,this.http=t,this.router=o,localStorage.getItem("token")){var r=JSON.parse(localStorage.getItem("token")),n=r.token,i=r.refresh_token;this.initializeToken(n,i)}}return e.prototype.login=function(e,t){var o=this,r=new n.Subject;return this.http.post(this.config.url.login,{username:e,password:t}).subscribe(function(e){o.updateToken(e.token,e.refresh_token),o.router.navigate([o.config.path.login]),r.next({iat:o.iatToken,exp:o.expToken,username:o.username,roles:o.roles})},function(e){r.error(e)}),r},e.prototype.logout=function(){localStorage.removeItem("token"),document.location.href=this.config.path.logout},e.prototype.updateToken=function(e,t){localStorage.setItem("token",JSON.stringify({token:e,refresh_token:t})),this.initializeToken(e,t)},e.prototype.initializeToken=function(e,t){this.connected=!0,this.token=e,this.refreshToken=t;var o=e.split("."),r=a.Base64.decode(o[1]),n=JSON.parse(r);this.iatToken=n.iat,this.expToken=n.exp,this.username=n.username,this.roles=n.roles},e.prototype.refresh=function(){return this.http.post(this.config.url.refresh,{refresh_token:this.refreshToken})},e.prototype.tokenNotExpired=function(){if(this.token&&this.expToken){var e=Math.floor(Date.now()/1e3);return this.expToken>e}return!1},e=c([o.Injectable(),s(0,o.Inject("config")),f("design:paramtypes",[Object,i.HttpClient,t.Router])],e)}(),p=function(e,t,o,r){var n,i=arguments.length,a=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,o,r);else for(var u=e.length-1;0<=u;u--)(n=e[u])&&(a=(i<3?n(a):3<i?n(t,o,a):n(t,o))||a);return 3<i&&a&&Object.defineProperty(t,o,a),a},h=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},d=function(){function e(e){this.auth=e}var n;return(n=e).getHeader=function(e,t){return e.clone({setHeaders:{Authorization:"Bearer "+t}})},e.prototype.intercept=function(t,o){var r=this;return this.auth.connected&&this.auth.tokenNotExpired()?o.handle(n.getHeader(t,this.auth.token)):this.auth.refreshToken&&t.url!==this.auth.config.url.refresh?this.auth.refresh().pipe(u.mergeMap(function(e){return r.auth.updateToken(e.token,e.refresh_token),o.handle(n.getHeader(t,e.token))})):o.handle(t).pipe(u.tap(function(e){},function(e){e instanceof i.HttpErrorResponse&&401===e.status&&r.auth.connected&&t.url===r.auth.config.url.refresh&&r.auth.logout()}))},e=n=p([o.Injectable(),h("design:paramtypes",[l])],e)}(),g=function(e,t,o,r){var n,i=arguments.length,a=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,o,r);else for(var u=e.length-1;0<=u;u--)(n=e[u])&&(a=(i<3?n(a):3<i?n(t,o,a):n(t,o))||a);return 3<i&&a&&Object.defineProperty(t,o,a),a},m=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},k=function(){function e(e,t){this.auth=e,this.router=t}return e.prototype.canActivate=function(){return!!this.auth.connected||(this.router.navigate([this.auth.config.path.logout]),!1)},e=g([o.Injectable(),m("design:paramtypes",[l,t.Router])],e)}(),y=function(e,t,o,r){var n,i=arguments.length,a=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,o):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,o,r);else for(var u=e.length-1;0<=u;u--)(n=e[u])&&(a=(i<3?n(a):3<i?n(t,o,a):n(t,o))||a);return 3<i&&a&&Object.defineProperty(t,o,a),a},v=function(){function e(){}var t;return(t=e).forRoot=function(e){return{ngModule:t,providers:[l,{provide:"config",useValue:e}]}},e=t=y([o.NgModule({declarations:[],imports:[r.CommonModule],providers:[{provide:i.HTTP_INTERCEPTORS,useClass:d,multi:!0},l,k],exports:[]})],e)}();e.TokenAuthModule=v,e.TokenAuthService=l,e.TokenAuthGuardService=k,Object.defineProperty(e,"__esModule",{value:!0})});